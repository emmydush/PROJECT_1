{% extends 'base.html' %}
{% load static %}

{% block title %}Voice Assistant Test - {{ business_settings.business_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/voice-assistant.css' %}">
{% endblock %}

{% block content %}
<div class="voice-test-container">
    <div class="voice-test-header">
        <h2><i class="fas fa-microphone-alt"></i> Voice Assistant Test</h2>
        <p>Test the voice recognition and synthesis functionality</p>
    </div>
    
    <div class="voice-test-card">
        <div class="voice-control-panel">
            <button id="startButton" class="voice-control-button">
                <i class="fas fa-microphone"></i>
            </button>
            <div id="status" class="voice-status">Ready</div>
        </div>
        
        <div class="voice-results">
            <h4>Recognition Results</h4>
            <div class="voice-recognized-text" id="recognizedText">
                Speech will appear here...
            </div>
            
            <h4>Interim Results</h4>
            <div class="voice-interim-results" id="interimResults">
                Interim results will appear here...
            </div>
        </div>
        
        <div class="voice-commands-list">
            <h4>Try These Commands</h4>
            <ul>
                <li><i class="fas fa-chart-line"></i> "Show profit" - Display profit report</li>
                <li><i class="fas fa-shopping-cart"></i> "Show sales" - Open sales dashboard</li>
                <li><i class="fas fa-cash-register"></i> "Point of sale" - Open point of sale system</li>
                <li><i class="fas fa-box"></i> "Add new product" - Add a new product</li>
                <li><i class="fas fa-warehouse"></i> "Check stock" - Show low quantity products</li>
                <li><i class="fas fa-users"></i> "Add customer" - Add a new customer</li>
                <li><i class="fas fa-industry"></i> "Add supplier" - Add a new supplier</li>
                <li><i class="fas fa-money-bill-wave"></i> "Add expense" - Record a new expense</li>
                <li><i class="fas fa-truck"></i> "Add purchase" - Create a new purchase order</li>
                <li><i class="fas fa-tags"></i> "Product categories" - Manage product categories</li>
                <li><i class="fas fa-cog"></i> "Settings" - Open system settings</li>
                <li><i class="fas fa-sign-out-alt"></i> "Logout" - Sign out of the system</li>
                <li><i class="fas fa-home"></i> "Go to dashboard" - Return to main dashboard</li>
            </ul>
        </div>
        
        <div class="voice-troubleshooting">
            <h4><i class="fas fa-exclamation-triangle"></i> Troubleshooting</h4>
            <ul>
                <li>Make sure you're using Chrome or Edge for best voice support</li>
                <li>Allow microphone access when prompted by the browser</li>
                <li>Check that your microphone is connected and working</li>
                <li>Ensure no other applications are using the microphone</li>
                <li>If speech doesn't work, try refreshing the page</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/voice-assistant.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startButton = document.getElementById('startButton');
    const status = document.getElementById('status');
    const recognizedText = document.getElementById('recognizedText');
    const interimResults = document.getElementById('interimResults');
    
    let recognition;
    let isListening = false;
    
    // Check for Web Speech API support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        console.warn('Web Speech API is not supported in this browser.');
        status.textContent = 'Not Supported - Use Chrome or Edge';
        startButton.disabled = true;
        return;
    }
    
    // Initialize speech recognition
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
    
    // Speech recognition events
    recognition.onstart = function() {
        isListening = true;
        status.textContent = 'Listening...';
        status.style.color = '#1976d2';
        startButton.innerHTML = '<i class="fas fa-microphone-alt"></i>';
    };
    
    recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        // Get interim and final results
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        // Update recognized text
        if (finalTranscript) {
            recognizedText.innerHTML = `<strong>Recognized:</strong> ${finalTranscript}`;
            processCommand(finalTranscript);
        }
        
        // Update interim results
        if (interimTranscript) {
            interimResults.innerHTML = `<em>Listening:</em> ${interimTranscript}`;
        } else {
            interimResults.innerHTML = 'Interim results will appear here...';
        }
    };
    
    recognition.onerror = function(event) {
        isListening = false;
        status.textContent = `Error: ${event.error}`;
        status.style.color = '#d32f2f';
        startButton.innerHTML = '<i class="fas fa-microphone"></i>';
        console.error('Speech recognition error', event.error);
    };
    
    recognition.onend = function() {
        isListening = false;
        status.textContent = 'Ready';
        status.style.color = '#666';
        startButton.innerHTML = '<i class="fas fa-microphone"></i>';
    };
    
    // Add click event to start button
    startButton.addEventListener('click', function() {
        if (isListening) {
            recognition.stop();
        } else {
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                status.textContent = 'Error starting recognition';
                status.style.color = '#d32f2f';
            }
        }
    });
    
    // Process recognized commands
    function processCommand(command) {
        command = command.toLowerCase().trim();
        
        // Enhanced logout command recognition with correct URL
        if (command.includes('logout') || command.includes('log out') || command.includes('sign out') || command.includes('exit')) {
            speakText('Logging out. Goodbye!');
            // Use the correct logout URL based on the URL patterns shown
            setTimeout(() => {
                window.location.href = '/accounts/logout/';
            }, 1500);
        } else if (command.includes('show profit') || command.includes('profit report')) {
            speakText('Showing profit and loss report.');
        } else if (command.includes('show sales') || command.includes('sales dashboard')) {
            speakText('Opening sales dashboard.');
        } else if (command.includes('point of sale') || command.includes('pos')) {
            speakText('Opening point of sale system.');
            window.location.href = '/sales/pos/';
        } else if (command.includes('add new product') || command.includes('create product')) {
            speakText('Opening add product form.');
        } else if (command.includes('check stock') || command.includes('low stock')) {
            speakText('Showing products with low quantity.');
        } else if (command.includes('add customer') || command.includes('create customer')) {
            speakText('Opening add customer form.');
        } else if (command.includes('add supplier') || command.includes('create supplier')) {
            speakText('Opening add supplier form.');
        } else if (command.includes('add expense') || command.includes('create expense')) {
            speakText('Opening add expense form.');
        } else if (command.includes('add purchase') || command.includes('create purchase')) {
            speakText('Opening add purchase form.');
        } else if (command.includes('product categories') || command.includes('categories')) {
            speakText('Showing product categories.');
        } else if (command.includes('settings') || command.includes('configuration')) {
            speakText('Opening settings page.');
        } else if (command.includes('dashboard') || command.includes('home')) {
            speakText('Returning to dashboard.');
        } else {
            speakText("I didn't understand that command. Try saying 'show profit', 'add new product', or 'logout'.");
        }
    }
    
    // Speak text function
    function speakText(text) {
        if (!window.speechSynthesis) {
            console.warn('Speech synthesis not supported');
            return;
        }
        
        // Cancel any ongoing speech
        window.speechSynthesis.cancel();
        
        // Create utterance
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        // Speak
        window.speechSynthesis.speak(utterance);
    }
});
</script>
{% endblock %}