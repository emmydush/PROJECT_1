{% extends 'base.html' %}

{% block title %}Voice Command Debug - {{ business_settings.business_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-bug"></i> Voice Command Debug</h2>
        </div>
        <p class="text-muted">Debug and test voice command functionality.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5>Voice Command Debugging</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <button id="testButton" class="btn btn-primary btn-lg rounded-circle" style="width: 80px; height: 80px;">
                        <i class="fas fa-microphone fa-2x"></i>
                    </button>
                    <div id="status" class="mt-2 text-muted">Ready</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Test Speech Synthesis</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="synthesisText" placeholder="Enter text to speak..." value="Hello! How can I help you today?">
                        <button class="btn btn-outline-secondary" type="button" id="speakButton">
                            <i class="fas fa-volume-up"></i> Speak
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Recognized Commands</label>
                    <div class="border rounded p-3 bg-light" id="commandLog" style="min-height: 100px; max-height: 200px; overflow-y: auto;">
                        <p class="text-muted mb-0">Commands will appear here...</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <button id="testGreeting" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-comment"></i> Test Greeting
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button id="testProfit" class="btn btn-info w-100 mb-2">
                            <i class="fas fa-chart-line"></i> Test Profit Command
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <button id="checkSupport" class="btn btn-warning w-100 mb-2">
                            <i class="fas fa-check-circle"></i> Check Browser Support
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button id="clearLog" class="btn btn-secondary w-100 mb-2">
                            <i class="fas fa-trash"></i> Clear Log
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-info-circle"></i> Debugging Tips</h6>
                    <ul class="mb-0">
                        <li>Click the microphone to test voice recognition</li>
                        <li>Use "Test Greeting" to simulate saying "HI"</li>
                        <li>Use "Test Profit Command" to simulate financial queries</li>
                        <li>Check browser console (F12) for detailed logs</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const testButton = document.getElementById('testButton');
    const status = document.getElementById('status');
    const synthesisText = document.getElementById('synthesisText');
    const speakButton = document.getElementById('speakButton');
    const commandLog = document.getElementById('commandLog');
    const testGreeting = document.getElementById('testGreeting');
    const testProfit = document.getElementById('testProfit');
    const checkSupport = document.getElementById('checkSupport');
    const clearLog = document.getElementById('clearLog');
    
    let recognition;
    let synthesis = window.speechSynthesis;
    let isListening = false;
    
    // Check for Web Speech API support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (SpeechRecognition) {
        try {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            console.log('Speech recognition initialized successfully');
        } catch (error) {
            console.error('Error initializing speech recognition:', error);
            logCommand('Error: Failed to initialize speech recognition');
        }
    } else {
        console.warn('Web Speech API Speech Recognition is not supported in this browser.');
        logCommand('Warning: Speech recognition not supported');
    }
    
    if (!synthesis) {
        console.warn('Web Speech API Speech Synthesis is not supported in this browser.');
        logCommand('Warning: Speech synthesis not supported');
    }
    
    // Speech recognition events
    if (recognition) {
        recognition.onstart = function() {
            isListening = true;
            status.textContent = 'Listening...';
            status.className = 'mt-2 text-primary';
            testButton.innerHTML = '<i class="fas fa-microphone-alt fa-2x"></i>';
            logCommand('Speech recognition started');
        };
        
        recognition.onresult = function(event) {
            let interimTranscript = '';
            let finalTranscript = '';
            
            // Get interim and final results
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }
            
            // Process final transcript
            if (finalTranscript) {
                logCommand(`Recognized: "${finalTranscript}"`);
                processCommand(finalTranscript);
            }
            
            // Show interim results
            if (interimTranscript) {
                status.textContent = `Listening: ${interimTranscript}`;
            }
        };
        
        recognition.onerror = function(event) {
            isListening = false;
            status.textContent = `Error: ${event.error}`;
            status.className = 'mt-2 text-danger';
            testButton.innerHTML = '<i class="fas fa-microphone fa-2x"></i>';
            logCommand(`Error: ${event.error}`);
            console.error('Speech recognition error', event.error);
        };
        
        recognition.onend = function() {
            isListening = false;
            status.textContent = 'Ready';
            status.className = 'mt-2 text-muted';
            testButton.innerHTML = '<i class="fas fa-microphone fa-2x"></i>';
            logCommand('Speech recognition ended');
        };
    }
    
    // Add click event to test button
    testButton.addEventListener('click', function() {
        if (!recognition) {
            alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
            return;
        }
        
        if (isListening) {
            recognition.stop();
        } else {
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                status.textContent = 'Error starting recognition';
                status.className = 'mt-2 text-danger';
                logCommand(`Error starting recognition: ${error.message}`);
            }
        }
    });
    
    // Speech synthesis
    speakButton.addEventListener('click', function() {
        const text = synthesisText.value;
        if (text && synthesis) {
            speakText(text);
            logCommand(`Speaking: "${text}"`);
        } else if (!synthesis) {
            logCommand('Error: Speech synthesis not supported');
        }
    });
    
    // Test greeting button
    testGreeting.addEventListener('click', function() {
        logCommand('Testing greeting command: "HI"');
        processGreetingCommand('hi');
    });
    
    // Test profit button
    testProfit.addEventListener('click', function() {
        logCommand('Testing profit command: "Show me profit"');
        processReportCommand('show me profit');
    });
    
    // Check support button
    checkSupport.addEventListener('click', function() {
        logCommand('=== Browser Support Check ===');
        logCommand(`Speech Recognition: ${SpeechRecognition ? 'Supported' : 'Not Supported'}`);
        logCommand(`Speech Synthesis: ${synthesis ? 'Supported' : 'Not Supported'}`);
        
        if (recognition) {
            logCommand('Speech Recognition initialized successfully');
        }
        
        if (synthesis) {
            logCommand(`Available voices: ${synthesis.getVoices().length}`);
        }
    });
    
    // Clear log button
    clearLog.addEventListener('click', function() {
        commandLog.innerHTML = '<p class="text-muted mb-0">Commands will appear here...</p>';
    });
    
    // Process command function
    function processCommand(command) {
        command = command.toLowerCase().trim();
        logCommand(`Processing command: "${command}"`);
        
        // Check for greeting commands
        if (processGreetingCommand(command)) return;
        
        // Check for report commands
        if (processReportCommand(command)) return;
        
        // Default response
        speakText("I didn't understand that command. Try saying 'hello' or 'show me profit'.");
        logCommand('Command not recognized, provided help response');
    }
    
    // Process greeting commands
    function processGreetingCommand(command) {
        if (command.includes('hello') || command.includes('hi') || command.includes('hey')) {
            speakText('Hello! How can I help you today?');
            logCommand('Greeting recognized, responded with greeting');
            return true;
        }
        return false;
    }
    
    // Process report commands
    function processReportCommand(command) {
        if (command.includes('profit') || command.includes('loss') || command.includes('earnings')) {
            speakText('I will show you the profit and loss report.');
            logCommand('Profit command recognized, would navigate to report');
            return true;
        }
        return false;
    }
    
    // Speak text function
    function speakText(text) {
        if (!synthesis) {
            logCommand('Error: Speech synthesis not available');
            return;
        }
        
        // Cancel any ongoing speech
        synthesis.cancel();
        
        // Create utterance
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        // Event listeners for debugging
        utterance.onstart = function() {
            logCommand(`Speech started: "${text}"`);
        };
        
        utterance.onend = function() {
            logCommand('Speech ended');
        };
        
        utterance.onerror = function(event) {
            logCommand(`Speech error: ${event.error}`);
        };
        
        // Speak
        synthesis.speak(utterance);
    }
    
    // Log command to display
    function logCommand(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('p');
        logEntry.className = 'mb-1';
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        
        // Remove placeholder if it exists
        if (commandLog.querySelector('.text-muted')) {
            commandLog.innerHTML = '';
        }
        
        commandLog.appendChild(logEntry);
        commandLog.scrollTop = commandLog.scrollHeight;
    }
});
</script>
{% endblock %}