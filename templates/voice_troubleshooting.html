{% extends 'base.html' %}

{% block title %}Voice Command Troubleshooting - {{ business_settings.business_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-tools"></i> Voice Command Troubleshooting</h2>
        </div>
        <p class="text-muted">Diagnose and fix voice command issues.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5>Voice Command Diagnostics</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <button id="diagnoseButton" class="btn btn-primary btn-lg rounded-circle" style="width: 80px; height: 80px;">
                        <i class="fas fa-stethoscope fa-2x"></i>
                    </button>
                    <div id="status" class="mt-2 text-muted">Ready</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Diagnostic Results</label>
                    <div class="border rounded p-3 bg-light" id="diagnosticResults" style="min-height: 150px; max-height: 300px; overflow-y: auto;">
                        <p class="text-muted mb-0">Click the button above to run diagnostics...</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <button id="testMicrophone" class="btn btn-info w-100">
                            <i class="fas fa-microphone"></i> Test Microphone
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button id="checkPermissions" class="btn btn-warning w-100">
                            <i class="fas fa-shield-alt"></i> Check Permissions
                        </button>
                    </div>
                </div>
                
                <div class="row mt-2">
                    <div class="col-md-6 mb-2">
                        <button id="fixPermissions" class="btn btn-success w-100">
                            <i class="fas fa-wrench"></i> Fix Permissions
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button id="resetVoice" class="btn btn-danger w-100">
                            <i class="fas fa-redo"></i> Reset Voice System
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle"></i> Common Solutions</h6>
                    <ul class="mb-0">
                        <li><strong>Browser:</strong> Use Chrome or Edge for best voice support</li>
                        <li><strong>Permissions:</strong> Allow microphone access when prompted</li>
                        <li><strong>Hardware:</strong> Check that your microphone is connected and working</li>
                        <li><strong>Settings:</strong> Ensure no other apps are using the microphone</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const diagnoseButton = document.getElementById('diagnoseButton');
    const status = document.getElementById('status');
    const diagnosticResults = document.getElementById('diagnosticResults');
    const testMicrophone = document.getElementById('testMicrophone');
    const checkPermissions = document.getElementById('checkPermissions');
    const fixPermissions = document.getElementById('fixPermissions');
    const resetVoice = document.getElementById('resetVoice');
    
    // Add click event to diagnose button
    diagnoseButton.addEventListener('click', function() {
        runDiagnostics();
    });
    
    // Test microphone button
    testMicrophone.addEventListener('click', function() {
        testMicrophoneFunction();
    });
    
    // Check permissions button
    checkPermissions.addEventListener('click', function() {
        checkMicrophonePermissions();
    });
    
    // Fix permissions button
    fixPermissions.addEventListener('click', function() {
        fixMicrophonePermissions();
    });
    
    // Reset voice system button
    resetVoice.addEventListener('click', function() {
        resetVoiceSystem();
    });
    
    // Run comprehensive diagnostics
    function runDiagnostics() {
        logResult('=== Starting Voice Command Diagnostics ===');
        status.textContent = 'Running diagnostics...';
        status.className = 'mt-2 text-primary';
        
        // Check browser support
        checkBrowserSupport();
        
        // Check microphone permissions
        checkMicrophonePermissions();
        
        // Test microphone hardware
        testMicrophoneFunction();
        
        // Check voice command system
        checkVoiceCommandSystem();
        
        setTimeout(() => {
            status.textContent = 'Diagnostics complete';
            status.className = 'mt-2 text-success';
            logResult('=== Diagnostics Complete ===');
        }, 3000);
    }
    
    // Check browser support for Web Speech API
    function checkBrowserSupport() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synthesis = window.speechSynthesis;
        
        if (SpeechRecognition) {
            logResult('✓ Web Speech API (Speech Recognition) - Supported');
        } else {
            logResult('✗ Web Speech API (Speech Recognition) - NOT Supported');
            logResult('  → Recommendation: Use Chrome or Edge browser');
        }
        
        if (synthesis) {
            logResult('✓ Web Speech API (Speech Synthesis) - Supported');
        } else {
            logResult('✗ Web Speech API (Speech Synthesis) - NOT Supported');
        }
    }
    
    // Check microphone permissions
    function checkMicrophonePermissions() {
        if (!navigator.permissions) {
            logResult('⚠ Permissions API - Not supported in this browser');
            return;
        }
        
        navigator.permissions.query({ name: 'microphone' })
            .then(function(permissionStatus) {
                switch (permissionStatus.state) {
                    case 'granted':
                        logResult('✓ Microphone Permission - Granted');
                        break;
                    case 'denied':
                        logResult('✗ Microphone Permission - Denied');
                        logResult('  → Solution: Click "Fix Permissions" button');
                        break;
                    case 'prompt':
                        logResult('⚠ Microphone Permission - Prompt needed');
                        logResult('  → Solution: Click "Fix Permissions" button');
                        break;
                    default:
                        logResult(`? Microphone Permission - Unknown state: ${permissionStatus.state}`);
                }
                
                // Listen for permission changes
                permissionStatus.onchange = function() {
                    logResult(`→ Microphone permission changed to: ${this.state}`);
                };
            })
            .catch(function(err) {
                logResult(`✗ Error checking permissions: ${err.message}`);
            });
    }
    
    // Test microphone function
    function testMicrophoneFunction() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            logResult('✗ Microphone Test - getUserMedia not supported');
            logResult('  → Recommendation: Use a modern browser like Chrome or Edge');
            return;
        }
        
        logResult('→ Testing microphone access...');
        
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                // Stop all tracks to release the microphone
                stream.getTracks().forEach(track => track.stop());
                logResult('✓ Microphone Test - SUCCESS');
                logResult('  → Your microphone is working properly');
            })
            .catch(function(err) {
                logResult('✗ Microphone Test - FAILED');
                logResult(`  → Error: ${err.message}`);
                
                if (err.name === 'NotAllowedError') {
                    logResult('  → Solution: Grant microphone permission in browser settings');
                } else if (err.name === 'NotFoundError') {
                    logResult('  → Solution: Connect a microphone and try again');
                } else if (err.name === 'NotReadableError') {
                    logResult('  → Solution: Check if another app is using the microphone');
                }
            });
    }
    
    // Check voice command system
    function checkVoiceCommandSystem() {
        if (typeof window.voiceCommand !== 'undefined') {
            logResult('✓ Voice Command System - Loaded');
            
            // Check if recognition is available
            if (window.voiceCommand.recognition) {
                logResult('✓ Speech Recognition - Initialized');
            } else {
                logResult('✗ Speech Recognition - Not initialized');
                logResult('  → Solution: Check browser compatibility');
            }
            
            // Check if synthesis is available
            if (window.voiceCommand.synthesis) {
                logResult('✓ Speech Synthesis - Available');
            } else {
                logResult('✗ Speech Synthesis - Not available');
            }
        } else {
            logResult('✗ Voice Command System - Not loaded');
            logResult('  → Solution: Refresh the page or check for JavaScript errors');
        }
    }
    
    // Fix microphone permissions
    function fixMicrophonePermissions() {
        logResult('=== Attempting to Fix Microphone Permissions ===');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            logResult('✗ Cannot fix permissions - getUserMedia not supported');
            return;
        }
        
        logResult('→ Requesting microphone access...');
        
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                // Stop all tracks to release the microphone
                stream.getTracks().forEach(track => track.stop());
                logResult('✓ Microphone access granted!');
                logResult('  → Try using voice commands again');
                alert('Microphone permission granted! You can now use voice commands.');
            })
            .catch(function(err) {
                logResult('✗ Failed to grant microphone permission');
                logResult(`  → Error: ${err.message}`);
                
                if (err.name === 'NotAllowedError') {
                    logResult('  → Manual fix required:');
                    logResult('    1. Click the lock icon in browser address bar');
                    logResult('    2. Find "Microphone" permission');
                    logResult('    3. Change to "Allow"');
                    logResult('    4. Refresh the page');
                    alert('Please manually enable microphone permissions:\n1. Click the lock icon in browser address bar\n2. Find "Microphone" permission\n3. Change to "Allow"\n4. Refresh the page');
                }
            });
    }
    
    // Reset voice system
    function resetVoiceSystem() {
        logResult('=== Resetting Voice Command System ===');
        
        try {
            // Reset voice command state
            if (window.voiceCommand) {
                // Stop any ongoing recognition
                if (window.voiceCommand.recognition && window.voiceCommand.isListening) {
                    window.voiceCommand.recognition.stop();
                }
                
                // Reset flags
                window.voiceCommand.isListening = false;
                window.voiceCommand.hasProvidedWelcome = false;
                
                // Reset UI
                if (window.voiceCommand.voiceButton) {
                    window.voiceCommand.voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                }
                
                if (window.voiceCommand.floatingButton) {
                    window.voiceCommand.floatingButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    window.voiceCommand.floatingButton.style.background = '#0d6efd';
                    window.voiceCommand.floatingButton.style.animation = 'none';
                }
                
                if (window.voiceCommand.statusIndicator) {
                    window.voiceCommand.statusIndicator.style.display = 'none';
                }
                
                logResult('✓ Voice Command System - Reset successful');
                logResult('  → Try using voice commands again');
                alert('Voice command system has been reset. Try using voice commands again.');
            } else {
                logResult('✗ Voice Command System - Not initialized');
                logResult('  → Refresh the page to reinitialize');
            }
        } catch (error) {
            logResult(`✗ Error resetting voice system: ${error.message}`);
        }
    }
    
    // Log diagnostic result
    function logResult(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('p');
        logEntry.className = 'mb-1';
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        
        // Remove placeholder if it exists
        if (diagnosticResults.querySelector('.text-muted')) {
            diagnosticResults.innerHTML = '';
        }
        
        diagnosticResults.appendChild(logEntry);
        diagnosticResults.scrollTop = diagnosticResults.scrollHeight;
    }
});
</script>
{% endblock %}