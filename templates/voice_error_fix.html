{% extends 'base.html' %}

{% block title %}Voice Error Fix - {{ business_settings.business_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-wrench"></i> Voice Error Fix</h2>
        </div>
        <p class="text-muted">Fix interrupted speech errors and audio conflicts.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5>Speech Error Resolution</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <button id="fixErrorButton" class="btn btn-primary btn-lg rounded-circle" style="width: 80px; height: 80px;">
                        <i class="fas fa-sync fa-2x"></i>
                    </button>
                    <div id="status" class="mt-2 text-muted">Ready</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Error Fix Results</label>
                    <div class="border rounded p-3 bg-light" id="errorResults" style="min-height: 150px; max-height: 300px; overflow-y: auto;">
                        <p class="text-muted mb-0">Click the button above to fix speech errors...</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <button id="clearSpeechQueue" class="btn btn-info w-100">
                            <i class="fas fa-broom"></i> Clear Speech Queue
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button id="resetAudioContext" class="btn btn-warning w-100">
                            <i class="fas fa-redo"></i> Reset Audio Context
                        </button>
                    </div>
                </div>
                
                <div class="row mt-2">
                    <div class="col-md-6 mb-2">
                        <button id="testAfterFix" class="btn btn-success w-100">
                            <i class="fas fa-check-circle"></i> Test After Fix
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button id="fullSystemReset" class="btn btn-danger w-100">
                            <i class="fas fa-power-off"></i> Full Reset
                        </button>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label class="form-label">Test Message</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="testMessage" placeholder="Enter test message..." value="This is a test message to verify the speech system is working properly.">
                        <button class="btn btn-outline-secondary" type="button" id="speakTestMessage">
                            <i class="fas fa-play"></i> Speak
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4">
                    <h6><i class="fas fa-exclamation-triangle"></i> "Interrupted" Error Solutions</h6>
                    <ul class="mb-0">
                        <li><strong>Clear Speech Queue:</strong> Cancel all pending speech requests</li>
                        <li><strong>Reset Audio Context:</strong> Fix browser audio system conflicts</li>
                        <li><strong>Full System Reset:</strong> Complete restart of voice system</li>
                        <li><strong>Browser Restart:</strong> If all else fails, restart your browser</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fixErrorButton = document.getElementById('fixErrorButton');
    const status = document.getElementById('status');
    const errorResults = document.getElementById('errorResults');
    const clearSpeechQueue = document.getElementById('clearSpeechQueue');
    const resetAudioContext = document.getElementById('resetAudioContext');
    const testAfterFix = document.getElementById('testAfterFix');
    const fullSystemReset = document.getElementById('fullSystemReset');
    const testMessage = document.getElementById('testMessage');
    const speakTestMessage = document.getElementById('speakTestMessage');
    
    // Add click event to main fix button
    fixErrorButton.addEventListener('click', function() {
        fixSpeechErrors();
    });
    
    // Clear speech queue
    clearSpeechQueue.addEventListener('click', function() {
        clearAllSpeech();
    });
    
    // Reset audio context
    resetAudioContext.addEventListener('click', function() {
        resetAudioSystem();
    });
    
    // Test after fix
    testAfterFix.addEventListener('click', function() {
        testSpeechAfterFix();
    });
    
    // Full system reset
    fullSystemReset.addEventListener('click', function() {
        performFullReset();
    });
    
    // Speak test message
    speakTestMessage.addEventListener('click', function() {
        const message = testMessage.value;
        if (message.trim()) {
            speakText(message);
            logResult(`â†’ Speaking test message: ${message}`);
        } else {
            logResult('âœ— No message entered');
        }
    });
    
    // Main error fix function
    function fixSpeechErrors() {
        logResult('=== Starting Speech Error Fix ===');
        status.textContent = 'Fixing speech errors...';
        status.className = 'mt-2 text-primary';
        
        // Clear speech queue
        clearAllSpeech();
        
        // Reset audio system
        resetAudioSystem();
        
        setTimeout(() => {
            status.textContent = 'Error fix complete';
            status.className = 'mt-2 text-success';
            logResult('=== Error Fix Complete ===');
            logResult('â†’ Try testing speech now');
        }, 2000);
    }
    
    // Clear all speech requests
    function clearAllSpeech() {
        try {
            const synthesis = window.speechSynthesis;
            if (synthesis) {
                synthesis.cancel();
                logResult('âœ“ Speech queue cleared');
            } else {
                logResult('âš  Speech synthesis not available');
            }
        } catch (error) {
            logResult(`âœ— Error clearing speech: ${error.message}`);
        }
    }
    
    // Reset audio system
    function resetAudioSystem() {
        try {
            // Clear speech synthesis
            const synthesis = window.speechSynthesis;
            if (synthesis) {
                synthesis.cancel();
                logResult('âœ“ Audio context reset');
            }
            
            // Force reload voices
            if (synthesis && synthesis.getVoices) {
                synthesis.getVoices();
                logResult('âœ“ Voice system reinitialized');
            }
        } catch (error) {
            logResult(`âœ— Error resetting audio: ${error.message}`);
        }
    }
    
    // Test speech after fix
    function testSpeechAfterFix() {
        logResult('=== Testing Speech After Fix ===');
        speakText("Speech system test after error fix. If you can hear this, the interrupted error has been resolved.");
    }
    
    // Perform full system reset
    function performFullReset() {
        logResult('=== Performing Full System Reset ===');
        
        try {
            // Clear speech
            clearAllSpeech();
            
            // Reset audio
            resetAudioSystem();
            
            // Try to reset voice command system if available
            if (typeof window.voiceCommand !== 'undefined') {
                if (window.voiceCommand.reset) {
                    window.voiceCommand.reset();
                    logResult('âœ“ Voice command system reset');
                }
            }
            
            // Reload voices
            setTimeout(() => {
                const synthesis = window.speechSynthesis;
                if (synthesis && synthesis.getVoices) {
                    synthesis.getVoices();
                    logResult('âœ“ Voice system reloaded');
                }
            }, 500);
            
            logResult('âœ… Full system reset completed');
            logResult('â†’ Try testing speech now');
            
        } catch (error) {
            logResult(`âœ— Error during full reset: ${error.message}`);
        }
    }
    
    // Speak text function with error handling for interrupted errors
    function speakText(text) {
        const synthesis = window.speechSynthesis;
        
        if (!synthesis) {
            logResult('âœ— Cannot speak - Speech synthesis not supported');
            return;
        }
        
        // Clear any ongoing speech first
        try {
            synthesis.cancel();
        } catch (e) {
            console.warn('Could not cancel ongoing speech:', e);
        }
        
        // Add small delay to prevent immediate conflicts
        setTimeout(() => {
            try {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Event listeners with specific handling for interrupted errors
                utterance.onstart = function() {
                    logResult(`ðŸ”Š Speech started: "${text}"`);
                    status.textContent = 'Speaking...';
                    status.className = 'mt-2 text-info';
                };
                
                utterance.onend = function() {
                    logResult('âœ… Speech ended successfully');
                    status.textContent = 'Ready';
                    status.className = 'mt-2 text-muted';
                };
                
                utterance.onerror = function(event) {
                    logResult(`âœ— Speech error: ${event.error}`);
                    
                    // Specific handling for interrupted errors
                    if (event.error === 'interrupted') {
                        logResult('  â†’ Solution: Speech was interrupted, trying again...');
                        // Retry once after a delay
                        setTimeout(() => {
                            speakText(text);
                        }, 1000);
                    } else {
                        status.textContent = `Error: ${event.error}`;
                        status.className = 'mt-2 text-danger';
                    }
                };
                
                // Speak the utterance
                synthesis.speak(utterance);
                logResult(`â†’ Queued speech: "${text}"`);
                
            } catch (error) {
                logResult(`âœ— Error creating utterance: ${error.message}`);
                
                // If we get an interrupted error, try again
                if (error.message.includes('interrupted')) {
                    logResult('  â†’ Retrying speech after interruption...');
                    setTimeout(() => {
                        speakText(text);
                    }, 1500);
                }
            }
        }, 200);
    }
    
    // Log error fix result
    function logResult(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('p');
        logEntry.className = 'mb-1';
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        
        // Remove placeholder if it exists
        if (errorResults.querySelector('.text-muted')) {
            errorResults.innerHTML = '';
        }
        
        errorResults.appendChild(logEntry);
        errorResults.scrollTop = errorResults.scrollHeight;
    }
    
    // Initialize with instructions
    logResult('Voice Error Fix System Ready');
    logResult('Click "Fix Error" button to resolve interrupted speech errors');
});
</script>
{% endblock %}