{% extends 'base.html' %}
{% load static %}

{% block title %}Camera Test{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Camera Test for Barcode Scanner</h1>
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5>Camera Access Test</h5>
                </div>
                <div class="card-body">
                    <p>This page will help you test if your camera is working properly for barcode scanning.</p>
                    
                    <div class="mb-3">
                        <button id="startCamera" class="btn btn-primary">Start Camera Test</button>
                        <button id="stopCamera" class="btn btn-secondary" disabled>Stop Camera</button>
                    </div>
                    
                    <div class="mb-3">
                        <div id="cameraStatus" class="alert alert-info">Camera not started</div>
                    </div>
                    
                    <div class="mb-3">
                        <div id="cameraContainer" style="position: relative; width: 100%; height: 300px; border: 1px solid #ccc; display: none;">
                            <video id="cameraVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>How Automatic Scanning Works:</h5>
                        <ol>
                            <li>Click "Start Camera Test" to access your camera</li>
                            <li>Allow camera access when prompted by your browser</li>
                            <li>Position a barcode in front of your camera</li>
                            <li><strong>The scanner will automatically detect and process the barcode</strong></li>
                            <li><strong>When a barcode is detected, the camera will automatically stop and close</strong></li>
                        </ol>
                        
                        <div class="alert alert-info">
                            <h6>Test Barcode:</h6>
                            <p>You can use this test barcode: <strong>123456789012</strong></p>
                            <p><a href="/media/test_barcodes/test_barcode.png" target="_blank">Click here to view the test barcode image</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let stream = null;
    
    document.getElementById('startCamera').addEventListener('click', async function() {
        const cameraStatus = document.getElementById('cameraStatus');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraVideo = document.getElementById('cameraVideo');
        const startButton = document.getElementById('startCamera');
        const stopButton = document.getElementById('stopCamera');
        
        try {
            cameraStatus.textContent = 'Requesting camera access...';
            cameraStatus.className = 'alert alert-warning';
            
            // Request camera access
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { min: 640 },
                    height: { min: 480 }
                } 
            });
            
            // Set up the video element
            cameraVideo.srcObject = stream;
            cameraVideo.play();
            
            // Show the camera container
            cameraContainer.style.display = 'block';
            
            // Update UI
            cameraStatus.textContent = 'Camera is working! Position a barcode in front of the camera to test automatic scanning.';
            cameraStatus.className = 'alert alert-success';
            startButton.disabled = true;
            stopButton.disabled = false;
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            cameraStatus.textContent = `Error accessing camera: ${error.message}`;
            cameraStatus.className = 'alert alert-danger';
            
            // Handle specific error types
            if (error.name === 'NotAllowedError') {
                cameraStatus.textContent = 'Camera access denied. Please allow camera access in your browser settings and try again.';
            } else if (error.name === 'NotFoundError') {
                cameraStatus.textContent = 'No camera found. Please connect a camera and try again.';
            } else if (error.name === 'NotReadableError') {
                cameraStatus.textContent = 'Camera is already in use. Close other applications using the camera.';
            }
        }
    });
    
    document.getElementById('stopCamera').addEventListener('click', function() {
        const cameraStatus = document.getElementById('cameraStatus');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraVideo = document.getElementById('cameraVideo');
        const startButton = document.getElementById('startCamera');
        const stopButton = document.getElementById('stopCamera'); // Fixed typo
        
        // Stop all tracks
        if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
        }
        
        // Clear the video element
        cameraVideo.srcObject = null;
        
        // Hide the camera container
        cameraContainer.style.display = 'none';
        
        // Update UI
        cameraStatus.textContent = 'Camera stopped.';
        cameraStatus.className = 'alert alert-info';
        startButton.disabled = false;
        stopButton.disabled = true;
    });
</script>
{% endblock %}
</body>
</html>