{% extends 'base.html' %}
{% load static %}

{% block title %}POS Scanner Test{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>POS Scanner Test</h1>
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Scanner Test</h5>
                </div>
                <div class="card-body">
                    <p>Click the button below to test the barcode scanner functionality.</p>
                    <button id="testScanner" class="btn btn-primary">Test Scanner</button>
                    <div id="testResult" class="mt-3"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Manual Barcode Entry</h5>
                </div>
                <div class="card-body">
                    <p>Enter a barcode manually to test product lookup:</p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="manualBarcode" placeholder="Enter barcode">
                        <button class="btn btn-outline-secondary" type="button" id="lookupBarcode">Lookup</button>
                    </div>
                    <div id="lookupResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scanner Modal -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scannerModalLabel">Scan Barcode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="scannerContainer" style="position: relative; width: 100%; height: 300px;">
                    <video id="scannerVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                    <div id="scannerOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 20%; border: 3px solid rgba(0, 255, 0, 0.8); box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5); animation: scannerPulse 2s infinite;"></div>
                    </div>
                </div>
                <div id="scannerStatus" class="mt-2 alert alert-info">Scanner not started</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let scannerActive = false;

    document.getElementById('testScanner').addEventListener('click', function() {
        const scannerModal = new bootstrap.Modal(document.getElementById('scannerModal'));
        scannerModal.show();
    });

    document.getElementById('lookupBarcode').addEventListener('click', function() {
        const barcode = document.getElementById('manualBarcode').value.trim();
        if (barcode) {
            lookupProduct(barcode);
        }
    });

    document.getElementById('manualBarcode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const barcode = document.getElementById('manualBarcode').value.trim();
            if (barcode) {
                lookupProduct(barcode);
            }
        }
    });

    // Handle scanner modal events
    const scannerModal = document.getElementById('scannerModal');
    if (scannerModal) {
        scannerModal.addEventListener('shown.bs.modal', function() {
            initScanner();
        });
        
        scannerModal.addEventListener('hidden.bs.modal', function() {
            stopScanner();
        });
    }

    function initScanner() {
        if (typeof Quagga === 'undefined') {
            document.getElementById('scannerStatus').textContent = 'Barcode scanner library not loaded';
            document.getElementById('scannerStatus').className = 'mt-2 alert alert-danger';
            return;
        }

        // Check if we're in a secure context
        if (!window.isSecureContext) {
            document.getElementById('scannerStatus').textContent = 'Camera requires HTTPS or localhost';
            document.getElementById('scannerStatus').className = 'mt-2 alert alert-warning';
            return;
        }

        const scannerVideo = document.getElementById('scannerVideo');
        const scannerStatus = document.getElementById('scannerStatus');
        
        if (!scannerVideo || !scannerStatus) {
            document.getElementById('scannerStatus').textContent = 'Scanner elements not found';
            document.getElementById('scannerStatus').className = 'mt-2 alert alert-danger';
            return;
        }

        scannerStatus.textContent = 'Initializing camera...';
        scannerStatus.className = 'mt-2 alert alert-warning';

        // Configure QuaggaJS
        const config = {
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: scannerVideo,
                constraints: {
                    facingMode: "environment", // Use rear camera
                    width: { min: 640 },
                    height: { min: 480 }
                }
            },
            decoder: {
                readers: [
                    "code_128_reader",
                    "ean_reader",
                    "ean_8_reader",
                    "code_39_reader",
                    "code_39_vin_reader",
                    "codabar_reader",
                    "upc_reader",
                    "upc_e_reader",
                    "i2of5_reader"
                ]
            },
            locator: {
                halfSample: false,
                patchSize: "medium"
            }
        };

        Quagga.init(config, function(err) {
            if (err) {
                console.error('Error initializing scanner:', err);
                let errorMessage = 'Error initializing camera';
                if (err.message) {
                    errorMessage += ': ' + err.message;
                } else if (typeof err === 'string') {
                    errorMessage += ': ' + err;
                }
                scannerStatus.textContent = errorMessage;
                scannerStatus.className = 'mt-2 alert alert-danger';
                
                // Handle specific error types
                if (err.name === 'NotAllowedError' || err.message.includes('Permission') || err.message.includes('permission')) {
                    scannerStatus.textContent = 'Camera permission denied. Please allow camera access.';
                } else if (err.name === 'NotFoundError' || err.message.includes('NotFoundError')) {
                    scannerStatus.textContent = 'No camera found. Please connect a camera and try again.';
                } else if (err.name === 'NotReadableError') {
                    scannerStatus.textContent = 'Camera is already in use. Close other applications using the camera.';
                }
                return;
            }

            // Start scanning
            Quagga.start();
            scannerActive = true;
            scannerStatus.textContent = 'Scanner started. Position barcode in the frame';
            scannerStatus.className = 'mt-2 alert alert-success';

            // Add drawing canvas for debug visualization
            Quagga.onProcessed(function(result) {
                var drawingCtx = Quagga.canvas.ctx.overlay;
                var drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                    }
                }
            });
        });

        // Register callback for detected barcodes
        Quagga.onDetected(function(result) {
            if (scannerActive) {
                const code = result.codeResult.code;
                console.log('Barcode detected:', code);
                scannerStatus.textContent = 'Barcode detected: ' + code;
                scannerStatus.className = 'mt-2 alert alert-success';
                
                // Lookup product
                lookupProduct(code);
                
                // Stop scanner after successful detection
                stopScanner();
                
                // Hide modal after a short delay
                setTimeout(function() {
                    const scannerModal = bootstrap.Modal.getInstance(document.getElementById('scannerModal'));
                    if (scannerModal) {
                        scannerModal.hide();
                    }
                }, 1000);
            }
        });
    }

    function stopScanner() {
        scannerActive = false;
        if (typeof Quagga !== 'undefined' && Quagga) {
            try {
                Quagga.stop();
                console.log('Quagga scanner stopped');
            } catch (e) {
                console.error('Error stopping Quagga:', e);
            }
        }
        
        const scannerStatus = document.getElementById('scannerStatus');
        if (scannerStatus) {
            scannerStatus.textContent = 'Scanner stopped';
            scannerStatus.className = 'mt-2 alert alert-info';
        }
    }

    function lookupProduct(barcode) {
        document.getElementById('testResult').innerHTML = '<div class="alert alert-info">Looking up product with barcode: ' + barcode + '</div>';
        
        // Fetch product by barcode
        fetch('/sales/product/barcode/' + encodeURIComponent(barcode) + '/')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('testResult').innerHTML = '<div class="alert alert-warning">Product not found: ' + data.error + '</div>';
                    document.getElementById('lookupResult').innerHTML = '<div class="alert alert-warning">Product not found: ' + data.error + '</div>';
                } else {
                    document.getElementById('testResult').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Product Found:</strong><br>
                            Name: ${data.name}<br>
                            Price: $${data.price}<br>
                            Stock: ${data.stock} ${data.unit}
                        </div>
                    `;
                    document.getElementById('lookupResult').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Product Found:</strong><br>
                            Name: ${data.name}<br>
                            Price: $${data.price}<br>
                            Stock: ${data.stock} ${data.unit}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error searching product:', error);
                document.getElementById('testResult').innerHTML = '<div class="alert alert-danger">Error searching product: ' + error.message + '</div>';
                document.getElementById('lookupResult').innerHTML = '<div class="alert alert-danger">Error searching product: ' + error.message + '</div>';
            });
    }
</script>

<style>
@keyframes scannerPulse {
    0% {
        border-color: rgba(0, 255, 0, 0.8);
        box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
    }
    50% {
        border-color: rgba(0, 255, 0, 1);
        box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.4);
    }
    100% {
        border-color: rgba(0, 255, 0, 0.8);
        box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
    }
}
</style>
{% endblock %}
</body>
</html>