{% extends 'base.html' %}
{% load static %}

{% block title %}Scanner Diagnostics{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Barcode Scanner Diagnostics</h1>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5>Scanner Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button id="runDiagnostics" class="btn btn-primary">Run Diagnostics</button>
                        <button id="clearResults" class="btn btn-secondary">Clear Results</button>
                    </div>
                    
                    <div class="mb-3">
                        <div id="diagnosticsStatus" class="alert alert-info">Ready to run diagnostics</div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Diagnostic Results:</h5>
                        <div id="diagnosticsResults" class="bg-light p-3" style="min-height: 200px; max-height: 400px; overflow-y: auto;">
                            <p class="text-muted">Click "Run Diagnostics" to start</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Troubleshooting Steps</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li><strong>Check Camera Permissions</strong> - Make sure your browser has permission to access the camera</li>
                        <li><strong>Test Camera Access</strong> - Visit the <a href="{% url 'sales:simple_camera_test' %}">simple camera test</a> to verify your camera works</li>
                        <li><strong>Check QuaggaJS Library</strong> - Make sure the barcode scanning library is loaded</li>
                        <li><strong>Verify Scanner Elements</strong> - Check that all required scanner HTML elements exist</li>
                        <li><strong>Try Different Browser</strong> - Some browsers work better with camera access</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('runDiagnostics').addEventListener('click', function() {
        const resultsDiv = document.getElementById('diagnosticsResults');
        const statusDiv = document.getElementById('diagnosticsStatus');
        
        // Clear previous results
        resultsDiv.innerHTML = '';
        
        // Update status
        statusDiv.textContent = 'Running diagnostics...';
        statusDiv.className = 'alert alert-warning';
        
        // Run diagnostics
        runScannerDiagnostics(resultsDiv, statusDiv);
    });
    
    document.getElementById('clearResults').addEventListener('click', function() {
        document.getElementById('diagnosticsResults').innerHTML = '<p class="text-muted">Click "Run Diagnostics" to start</p>';
        document.getElementById('diagnosticsStatus').textContent = 'Ready to run diagnostics';
        document.getElementById('diagnosticsStatus').className = 'alert alert-info';
    });
    
    function runScannerDiagnostics(resultsDiv, statusDiv) {
        let results = [];
        
        // Add result to display
        function addResult(message, type = 'info') {
            const badgeClass = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning text-dark',
                'info': 'bg-info text-dark'
            }[type] || 'bg-secondary';
            
            results.push(`<div class="mb-2"><span class="badge ${badgeClass}">${type.toUpperCase()}</span> ${message}</div>`);
            resultsDiv.innerHTML = results.join('');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Start diagnostics
        addResult('Starting scanner diagnostics...', 'info');
        
        // Check if we're in a secure context
        if (window.isSecureContext) {
            addResult('✓ Running in secure context (HTTPS or localhost)', 'success');
        } else {
            addResult('✗ Not running in secure context. Camera access requires HTTPS or localhost', 'error');
        }
        
        // Check if QuaggaJS is loaded
        if (typeof Quagga !== 'undefined') {
            addResult('✓ QuaggaJS library is loaded', 'success');
        } else {
            addResult('✗ QuaggaJS library is not loaded', 'error');
            statusDiv.textContent = 'Diagnostics completed with errors';
            statusDiv.className = 'alert alert-danger';
            return;
        }
        
        // Check scanner elements with detailed information
        addResult('Checking scanner elements...', 'info');
        
        const scannerModal = document.getElementById('scannerModal');
        if (scannerModal) {
            addResult('✓ Scanner modal element found', 'success');
            addResult(`  Modal ID: ${scannerModal.id}`, 'info');
            addResult(`  Modal class: ${scannerModal.className}`, 'info');
        } else {
            addResult('✗ Scanner modal element not found', 'error');
            addResult('  Looking for element with ID: scannerModal', 'info');
        }
        
        const scannerVideo = document.getElementById('scannerVideo');
        if (scannerVideo) {
            addResult('✓ Scanner video element found', 'success');
            addResult(`  Video ID: ${scannerVideo.id}`, 'info');
            addResult(`  Video class: ${scannerVideo.className}`, 'info');
        } else {
            addResult('✗ Scanner video element not found', 'error');
            addResult('  Looking for element with ID: scannerVideo', 'info');
        }
        
        const scannerStatus = document.getElementById('scannerStatus');
        if (scannerStatus) {
            addResult('✓ Scanner status element found', 'success');
            addResult(`  Status ID: ${scannerStatus.id}`, 'info');
            addResult(`  Status class: ${scannerStatus.className}`, 'info');
            addResult(`  Status text: ${scannerStatus.textContent}`, 'info');
        } else {
            addResult('✗ Scanner status element not found', 'error');
            addResult('  Looking for element with ID: scannerStatus', 'info');
        }
        
        const scannerContainer = document.getElementById('scannerContainer');
        if (scannerContainer) {
            addResult('✓ Scanner container element found', 'success');
            addResult(`  Container ID: ${scannerContainer.id}`, 'info');
            addResult(`  Container class: ${scannerContainer.className}`, 'info');
        } else {
            addResult('✗ Scanner container element not found', 'error');
            addResult('  Looking for element with ID: scannerContainer', 'info');
        }
        
        // Check if scanner modal is properly structured
        if (scannerModal) {
            addResult('Checking scanner modal structure...', 'info');
            
            // Look for all expected elements within the modal
            const expectedElements = [
                { id: 'scannerVideo', desc: 'Video element' },
                { id: 'scannerStatus', desc: 'Status element' },
                { id: 'scannerContainer', desc: 'Container element' },
                { id: 'scannerOverlay', desc: 'Overlay element' },
                { id: 'scannerModalLabel', desc: 'Modal title' }
            ];
            
            expectedElements.forEach(element => {
                const el = document.getElementById(element.id);
                if (el) {
                    addResult(`✓ ${element.desc} found (ID: ${element.id})`, 'success');
                } else {
                    addResult(`✗ ${element.desc} not found (ID: ${element.id})`, 'warning');
                }
            });
        }
        
        // Check camera permissions
        if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    if (videoDevices.length > 0) {
                        addResult(`✓ Found ${videoDevices.length} camera(s)`, 'success');
                        videoDevices.forEach((device, index) => {
                            addResult(`  Camera ${index + 1}: ${device.label || 'Unnamed camera'}`, 'info');
                        });
                    } else {
                        addResult('✗ No cameras found', 'error');
                    }
                    
                    // Final status
                    const hasErrors = results.some(result => result.includes('✗'));
                    if (hasErrors) {
                        statusDiv.textContent = 'Diagnostics completed with errors';
                        statusDiv.className = 'alert alert-danger';
                    } else {
                        statusDiv.textContent = 'Diagnostics completed successfully';
                        statusDiv.className = 'alert alert-success';
                    }
                })
                .catch(err => {
                    addResult(`✗ Error enumerating devices: ${err.message}`, 'error');
                    statusDiv.textContent = 'Diagnostics completed with errors';
                    statusDiv.className = 'alert alert-danger';
                });
        } else {
            addResult('✗ Media devices API not supported', 'error');
            statusDiv.textContent = 'Diagnostics completed with errors';
            statusDiv.className = 'alert alert-danger';
        }
    }
</script>
{% endblock %}
</body>
</html>