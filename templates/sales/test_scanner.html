{% extends 'base.html' %}

{% block title %}Test Barcode Scanner{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Test Barcode Scanner</h1>
    <div class="mb-3">
        <button id="startScanner" class="btn btn-primary">Start Scanner</button>
        <button id="stopScanner" class="btn btn-secondary" disabled>Stop Scanner</button>
    </div>
    <div class="mb-3">
        <div id="scanner-status" class="alert alert-info">Scanner not started</div>
    </div>
    <div class="mb-3">
        <div id="scanner-container" style="position: relative; width: 100%; height: 400px; border: 1px solid #ccc;">
            <video id="scanner-video" style="width: 100%; height: 100%; object-fit: cover;"></video>
            <div id="scanner-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 20%; border: 3px solid rgba(0, 255, 0, 0.8); box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5); animation: scannerPulse 2s infinite;"></div>
            </div>
        </div>
    </div>
    <div id="result"></div>
</div>

<style>
@keyframes scannerPulse {
    0% {
        border-color: rgba(0, 255, 0, 0.8);
        box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
    }
    50% {
        border-color: rgba(0, 255, 0, 1);
        box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.4);
    }
    100% {
        border-color: rgba(0, 255, 0, 0.8);
        box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    let scannerActive = false;

    // Check if QuaggaJS is loaded
    if (typeof Quagga !== 'undefined') {
        console.log('QuaggaJS loaded successfully');
        document.getElementById('scanner-status').textContent = 'QuaggaJS loaded successfully';
        document.getElementById('scanner-status').className = 'alert alert-success';
    } else {
        console.error('QuaggaJS not loaded');
        document.getElementById('scanner-status').textContent = 'Error: QuaggaJS not loaded';
        document.getElementById('scanner-status').className = 'alert alert-danger';
    }

    document.getElementById('startScanner').addEventListener('click', function() {
        initScanner();
    });

    document.getElementById('stopScanner').addEventListener('click', function() {
        stopScanner();
    });

    function initScanner() {
        console.log('Initializing scanner...');
        document.getElementById('scanner-status').textContent = 'Initializing camera...';
        document.getElementById('scanner-status').className = 'alert alert-warning';
        document.getElementById('startScanner').disabled = true;
        document.getElementById('stopScanner').disabled = false;

        // Check if we're in a secure context
        if (!window.isSecureContext) {
            console.warn('Not in secure context - camera access may be restricted');
            document.getElementById('scanner-status').textContent = 'Camera requires HTTPS or localhost';
            document.getElementById('scanner-status').className = 'alert alert-warning';
            document.getElementById('startScanner').disabled = false;
            document.getElementById('stopScanner').disabled = true;
            return;
        }

        // Check if QuaggaJS is available
        if (typeof Quagga === 'undefined') {
            console.error('QuaggaJS library not loaded');
            document.getElementById('scanner-status').textContent = 'Error: Barcode scanner library not loaded';
            document.getElementById('scanner-status').className = 'alert alert-danger';
            document.getElementById('startScanner').disabled = false;
            document.getElementById('stopScanner').disabled = true;
            return;
        }

        // Configure QuaggaJS
        const config = {
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#scanner-video'),
                constraints: {
                    facingMode: "environment", // Use rear camera
                    width: { min: 640 },
                    height: { min: 480 }
                }
            },
            decoder: {
                readers: [
                    "code_128_reader",
                    "ean_reader",
                    "ean_8_reader",
                    "code_39_reader",
                    "code_39_vin_reader",
                    "codabar_reader",
                    "upc_reader",
                    "upc_e_reader",
                    "i2of5_reader"
                ]
            },
            locator: {
                halfSample: false,
                patchSize: "medium",
                debug: {
                    showCanvas: true,
                    showPatches: false,
                    showFoundPatches: false,
                    showSkeleton: false,
                    showLabels: false,
                    showPatchLabels: false,
                    showRemainingPatchLabels: false,
                    boxFromPatches: {
                        showTransformed: false,
                        showTransformedBox: false,
                        showBB: false
                    }
                }
            }
        };

        console.log('QuaggaJS config:', config);

        Quagga.init(config, function(err) {
            if (err) {
                console.error('Error initializing scanner:', err);
                let errorMessage = 'Error initializing camera';
                if (err.message) {
                    errorMessage += ': ' + err.message;
                } else if (typeof err === 'string') {
                    errorMessage += ': ' + err;
                }
                document.getElementById('scanner-status').textContent = errorMessage;
                document.getElementById('scanner-status').className = 'alert alert-danger';
                document.getElementById('startScanner').disabled = false;
                document.getElementById('stopScanner').disabled = true;
                
                // Handle specific error types
                if (err.name === 'NotAllowedError' || err.message.includes('Permission') || err.message.includes('permission')) {
                    document.getElementById('scanner-status').textContent = 'Camera permission denied. Please allow camera access.';
                } else if (err.name === 'NotFoundError' || err.message.includes('NotFoundError')) {
                    document.getElementById('scanner-status').textContent = 'No camera found. Please connect a camera and try again.';
                } else if (err.name === 'NotReadableError') {
                    document.getElementById('scanner-status').textContent = 'Camera is already in use. Close other applications using the camera.';
                }
                return;
            }

            console.log('Scanner initialized successfully');
            // Start scanning
            Quagga.start();
            scannerActive = true;
            document.getElementById('scanner-status').textContent = 'Scanner started. Position barcode in the frame';
            document.getElementById('scanner-status').className = 'alert alert-success';

            // Add drawing canvas for debug visualization
            Quagga.onProcessed(function(result) {
                var drawingCtx = Quagga.canvas.ctx.overlay;
                var drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                    }
                }
            });
        });

        // Register callback for detected barcodes
        Quagga.onDetected(function(result) {
            if (scannerActive) {
                const code = result.codeResult.code;
                console.log('Barcode detected:', code);
                document.getElementById('result').innerHTML = `<div class="alert alert-success">Barcode detected: ${code}</div>`;
                document.getElementById('scanner-status').textContent = 'Barcode detected: ' + code;
                document.getElementById('scanner-status').className = 'alert alert-success';
                
                // Search for product
                fetch(`/sales/product/barcode/${code}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            document.getElementById('result').innerHTML += `<div class="alert alert-warning">Product not found: ${data.error}</div>`;
                        } else {
                            document.getElementById('result').innerHTML += `
                                <div class="alert alert-info">
                                    <strong>Product Found:</strong><br>
                                    Name: ${data.name}<br>
                                    Price: $${data.price}<br>
                                    Stock: ${data.stock} ${data.unit}
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error searching product:', error);
                        document.getElementById('result').innerHTML += `<div class="alert alert-danger">Error searching product: ${error.message}</div>`;
                    });
            }
        });
    }

    function stopScanner() {
        scannerActive = false;
        if (typeof Quagga !== 'undefined' && Quagga) {
            try {
                Quagga.stop();
                console.log('Quagga scanner stopped');
            } catch (e) {
                console.error('Error stopping Quagga:', e);
            }
        } else {
            console.log('Quagga not available or not initialized');
        }
        document.getElementById('scanner-status').textContent = 'Scanner stopped';
        document.getElementById('scanner-status').className = 'alert alert-info';
        document.getElementById('startScanner').disabled = false;
        document.getElementById('stopScanner').disabled = true;
    }
</script>
{% endblock %}