<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Barcode Scanner Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="{% static 'js/quagga.min.js' %}"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Automatic Barcode Scanner Test</h1>
        
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5>How It Works</h5>
                    </div>
                    <div class="card-body">
                        <p>This demo shows how the automatic barcode scanner works in the POS system:</p>
                        <ol>
                            <li>Click "Start Scanner" below</li>
                            <li>Allow camera access when prompted</li>
                            <li>Position the test barcode in front of your camera</li>
                            <li><strong>The scanner will automatically detect the barcode and stop</strong></li>
                        </ol>
                        
                        <div class="alert alert-info">
                            <h6>Test Barcode:</h6>
                            <p>Barcode: <strong>123456789012</strong></p>
                            <p><a href="/media/test_barcodes/test_barcode.png" target="_blank">View test barcode image</a></p>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button id="startScanner" class="btn btn-primary btn-lg">Start Scanner</button>
                            <button id="stopScanner" class="btn btn-secondary btn-lg" disabled>Stop Scanner</button>
                        </div>
                        
                        <div class="mt-3">
                            <div id="scannerStatus" class="alert alert-info text-center">Scanner not started</div>
                        </div>
                        
                        <div class="mt-3" id="scannerContainer" style="position: relative; width: 100%; height: 300px; border: 1px solid #ccc; display: none;">
                            <video id="scannerVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                            <div id="scannerOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 20%; border: 3px solid rgba(0, 255, 0, 0.8); box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5); animation: scannerPulse 2s infinite;"></div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div id="scanResult" class="alert" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="{% url 'sales:pos' %}" class="btn btn-success">Go to POS System</a>
                </div>
            </div>
        </div>
    </div>

    <style>
    @keyframes scannerPulse {
        0% {
            border-color: rgba(0, 255, 0, 0.8);
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
        }
        50% {
            border-color: rgba(0, 255, 0, 1);
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.4);
        }
        100% {
            border-color: rgba(0, 255, 0, 0.8);
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
        }
    }
    </style>

    <script>
        let scannerActive = false;
        
        document.getElementById('startScanner').addEventListener('click', function() {
            initScanner();
        });
        
        document.getElementById('stopScanner').addEventListener('click', function() {
            stopScanner();
        });
        
        function initScanner() {
            if (typeof Quagga === 'undefined') {
                document.getElementById('scannerStatus').textContent = 'Barcode scanner library not loaded';
                document.getElementById('scannerStatus').className = 'alert alert-danger text-center';
                return;
            }

            const scannerVideo = document.getElementById('scannerVideo');
            const scannerStatus = document.getElementById('scannerStatus');
            const scannerContainer = document.getElementById('scannerContainer');
            const startButton = document.getElementById('startScanner');
            const stopButton = document.getElementById('stopScanner');
            
            if (!scannerVideo || !scannerStatus) {
                document.getElementById('scannerStatus').textContent = 'Scanner elements not found';
                document.getElementById('scannerStatus').className = 'alert alert-danger text-center';
                return;
            }

            scannerStatus.textContent = 'Initializing camera...';
            scannerStatus.className = 'alert alert-warning text-center';
            scannerContainer.style.display = 'block';
            startButton.disabled = true;
            stopButton.disabled = false;

            // Configure QuaggaJS
            const config = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerVideo,
                    constraints: {
                        facingMode: "environment",
                        width: { min: 640 },
                        height: { min: 480 }
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "upc_reader"
                    ]
                },
                locator: {
                    halfSample: false,
                    patchSize: "medium"
                }
            };

            Quagga.init(config, function(err) {
                if (err) {
                    console.error('Error initializing scanner:', err);
                    let errorMessage = 'Error initializing camera';
                    if (err.message) {
                        errorMessage += ': ' + err.message;
                    }
                    scannerStatus.textContent = errorMessage;
                    scannerStatus.className = 'alert alert-danger text-center';
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    return;
                }

                // Start scanning
                Quagga.start();
                scannerActive = true;
                scannerStatus.textContent = 'Scanner started. Position barcode in the frame';
                scannerStatus.className = 'alert alert-success text-center';

                // Add drawing canvas for debug visualization
                Quagga.onProcessed(function(result) {
                    var drawingCtx = Quagga.canvas.ctx.overlay;
                    var drawingCanvas = Quagga.canvas.dom.overlay;

                    if (result) {
                        if (result.boxes) {
                            drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                            result.boxes.filter(function (box) {
                                return box !== result.box;
                            }).forEach(function (box) {
                                Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                            });
                        }

                        if (result.box) {
                            Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                        }

                        if (result.codeResult && result.codeResult.code) {
                            Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                        }
                    }
                });
            });

            // Register callback for detected barcodes - AUTOMATICALLY STOP WHEN DETECTED
            Quagga.onDetected(function(result) {
                if (scannerActive) {
                    const code = result.codeResult.code;
                    console.log('Barcode detected:', code);
                    
                    // Show result
                    const scanResult = document.getElementById('scanResult');
                    scanResult.innerHTML = `
                        <h5>Barcode Detected!</h5>
                        <p><strong>Code:</strong> ${code}</p>
                        <p class="mb-0">Scanner will automatically stop in 2 seconds...</p>
                    `;
                    scanResult.className = 'alert alert-success';
                    scanResult.style.display = 'block';
                    
                    scannerStatus.textContent = 'Barcode detected: ' + code;
                    scannerStatus.className = 'alert alert-success text-center';
                    
                    // Stop scanner and close automatically after 2 seconds
                    setTimeout(function() {
                        stopScanner();
                        scannerContainer.style.display = 'none';
                        startButton.disabled = false;
                        stopButton.disabled = true;
                    }, 2000);
                }
            });
        }

        function stopScanner() {
            scannerActive = false;
            if (typeof Quagga !== 'undefined' && Quagga) {
                try {
                    Quagga.stop();
                    console.log('Quagga scanner stopped');
                } catch (e) {
                    console.error('Error stopping Quagga:', e);
                }
            }
            
            const scannerStatus = document.getElementById('scannerStatus');
            if (scannerStatus) {
                scannerStatus.textContent = 'Scanner stopped';
                scannerStatus.className = 'alert alert-info text-center';
            }
        }
    </script>
</body>
</html>