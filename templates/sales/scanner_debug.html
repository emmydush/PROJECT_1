{% extends 'base.html' %}
{% load static %}

{% block title %}Scanner Debug{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Barcode Scanner Debug</h1>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5>Scanner Debug Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button id="runDebug" class="btn btn-primary">Run Debug Check</button>
                        <button id="clearDebug" class="btn btn-secondary">Clear Results</button>
                    </div>
                    
                    <div class="mb-3">
                        <div id="debugStatus" class="alert alert-info">Ready to run debug check</div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Debug Results:</h5>
                        <div id="debugResults" class="bg-light p-3" style="min-height: 300px; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                            <p class="text-muted">Click "Run Debug Check" to start</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Manual Scanner Test</h5>
                </div>
                <div class="card-body">
                    <p>Click the button below to manually test scanner element detection:</p>
                    <button id="manualTest" class="btn btn-success">Manual Element Test</button>
                    <div id="manualTestResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('runDebug').addEventListener('click', function() {
        const resultsDiv = document.getElementById('debugResults');
        const statusDiv = document.getElementById('debugStatus');
        
        // Clear previous results
        resultsDiv.innerHTML = '';
        
        // Update status
        statusDiv.textContent = 'Running debug check...';
        statusDiv.className = 'alert alert-warning';
        
        // Run debug
        runScannerDebug(resultsDiv, statusDiv);
    });
    
    document.getElementById('clearDebug').addEventListener('click', function() {
        document.getElementById('debugResults').innerHTML = '<p class="text-muted">Click "Run Debug Check" to start</p>';
        document.getElementById('debugStatus').textContent = 'Ready to run debug check';
        document.getElementById('debugStatus').className = 'alert alert-info';
    });
    
    document.getElementById('manualTest').addEventListener('click', function() {
        const resultsDiv = document.getElementById('manualTestResults');
        resultsDiv.innerHTML = '<div class="alert alert-info">Testing scanner elements...</div>';
        
        // Test elements manually
        setTimeout(() => {
            const scannerModal = document.getElementById('scannerModal');
            const scannerVideo = document.getElementById('scannerVideo');
            const scannerStatus = document.getElementById('scannerStatus');
            const scannerContainer = document.getElementById('scannerContainer');
            
            let html = '<div class="alert alert-info">Manual Element Test Results:</div>';
            
            if (scannerModal) {
                html += `<div class="alert alert-success">✓ Scanner modal found<br>
                         ID: ${scannerModal.id}<br>
                         Class: ${scannerModal.className}<br>
                         Style: ${scannerModal.style.cssText}<br>
                         Parent: ${scannerModal.parentElement ? scannerModal.parentElement.tagName : 'None'}</div>`;
            } else {
                html += '<div class="alert alert-danger">✗ Scanner modal NOT found</div>';
            }
            
            if (scannerVideo) {
                html += `<div class="alert alert-success">✓ Scanner video found<br>
                         ID: ${scannerVideo.id}<br>
                         Class: ${scannerVideo.className}<br>
                         Style: ${scannerVideo.style.cssText}</div>`;
            } else {
                html += '<div class="alert alert-danger">✗ Scanner video NOT found</div>';
            }
            
            if (scannerStatus) {
                html += `<div class="alert alert-success">✓ Scanner status found<br>
                         ID: ${scannerStatus.id}<br>
                         Class: ${scannerStatus.className}<br>
                         Text: ${scannerStatus.textContent}<br>
                         Style: ${scannerStatus.style.cssText}</div>`;
            } else {
                html += '<div class="alert alert-danger">✗ Scanner status NOT found</div>';
            }
            
            if (scannerContainer) {
                html += `<div class="alert alert-success">✓ Scanner container found<br>
                         ID: ${scannerContainer.id}<br>
                         Class: ${scannerContainer.className}<br>
                         Style: ${scannerContainer.style.cssText}</div>`;
            } else {
                html += '<div class="alert alert-danger">✗ Scanner container NOT found</div>';
            }
            
            resultsDiv.innerHTML = html;
        }, 500);
    });
    
    function runScannerDebug(resultsDiv, statusDiv) {
        let results = [];
        
        // Add result to display
        function addResult(message) {
            results.push(`<div class="mb-1">${message}</div>`);
            resultsDiv.innerHTML = results.join('');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Start debug
        addResult('<strong>=== Scanner Debug Started ===</strong>');
        addResult(`Timestamp: ${new Date().toISOString()}`);
        addResult(`User Agent: ${navigator.userAgent}`);
        addResult(`Secure Context: ${window.isSecureContext}`);
        addResult('');
        
        // Check document ready state
        addResult(`<strong>Document Ready State:</strong> ${document.readyState}`);
        
        // Check if we're inside a modal
        addResult(`<strong>Current URL:</strong> ${window.location.href}`);
        
        // List all elements in the document
        addResult('');
        addResult('<strong>All Elements in Document:</strong>');
        const allElements = document.querySelectorAll('*');
        addResult(`Total elements: ${allElements.length}`);
        
        // Look for elements with IDs containing "scanner"
        addResult('');
        addResult('<strong>Elements with "scanner" in ID:</strong>');
        const scannerElements = document.querySelectorAll('[id*="scanner"]');
        if (scannerElements.length > 0) {
            scannerElements.forEach(el => {
                addResult(`- ${el.tagName}#${el.id} (${el.className})`);
            });
        } else {
            addResult('No elements with "scanner" in ID found');
        }
        
        // Check for modal elements specifically
        addResult('');
        addResult('<strong>Modal Elements:</strong>');
        const modals = document.querySelectorAll('.modal');
        if (modals.length > 0) {
            modals.forEach((modal, index) => {
                addResult(`Modal ${index + 1}: ${modal.id || 'No ID'} (${modal.className})`);
                // Check for scanner elements within this modal
                const scannerEls = modal.querySelectorAll('[id*="scanner"]');
                if (scannerEls.length > 0) {
                    scannerEls.forEach(el => {
                        addResult(`  - ${el.tagName}#${el.id} (${el.className})`);
                    });
                } else {
                    addResult('  - No scanner elements found in this modal');
                }
            });
        } else {
            addResult('No modal elements found');
        }
        
        // Check specifically for our scanner modal
        addResult('');
        addResult('<strong>Scanner Modal Check:</strong>');
        const scannerModal = document.getElementById('scannerModal');
        if (scannerModal) {
            addResult('✓ Scanner modal element found');
            addResult(`  ID: ${scannerModal.id}`);
            addResult(`  Class: ${scannerModal.className}`);
            addResult(`  Display: ${scannerModal.style.display}`);
            addResult(`  Visibility: ${scannerModal.style.visibility}`);
            
            // Check if it's in the DOM
            addResult(`  In DOM: ${document.contains(scannerModal)}`);
            
            // Check children
            addResult('  Children:');
            for (let i = 0; i < scannerModal.children.length; i++) {
                const child = scannerModal.children[i];
                addResult(`    ${child.tagName}#${child.id} (${child.className})`);
            }
            
            // Check for specific scanner elements
            const specificElements = [
                'scannerVideo',
                'scannerStatus',
                'scannerContainer',
                'scannerOverlay'
            ];
            
            addResult('  Specific Element Check:');
            specificElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    addResult(`    ✓ ${id} found (${el.tagName})`);
                } else {
                    addResult(`    ✗ ${id} NOT found`);
                }
            });
        } else {
            addResult('✗ Scanner modal element NOT found');
            addResult('  This is likely the cause of the "Scanner elements not found" error');
        }
        
        // Final status
        statusDiv.textContent = 'Debug completed';
        statusDiv.className = 'alert alert-success';
        
        addResult('');
        addResult('<strong>=== Debug Completed ===</strong>');
    }
</script>
{% endblock %}
</body>
</html>