{% extends 'base.html' %}

{% block title %}Voice Response Test - {{ business_settings.business_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-comment-dots"></i> Voice Response Test</h2>
        </div>
        <p class="text-muted">Test voice responses and troubleshoot why the system isn't replying.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5>Voice Response Diagnostics</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <button id="testResponseButton" class="btn btn-primary btn-lg rounded-circle" style="width: 80px; height: 80px;">
                        <i class="fas fa-volume-up fa-2x"></i>
                    </button>
                    <div id="status" class="mt-2 text-muted">Ready</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Response Test Results</label>
                    <div class="border rounded p-3 bg-light" id="responseResults" style="min-height: 150px; max-height: 300px; overflow-y: auto;">
                        <p class="text-muted mb-0">Click the button above to test voice responses...</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <button id="testBasicResponse" class="btn btn-info w-100">
                            <i class="fas fa-comment"></i> Test Basic Response
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button id="testGreetingResponse" class="btn btn-success w-100">
                            <i class="fas fa-hand-sparkles"></i> Test Greeting
                        </button>
                    </div>
                </div>
                
                <div class="row mt-2">
                    <div class="col-md-6 mb-2">
                        <button id="testCustomResponse" class="btn btn-warning w-100">
                            <i class="fas fa-keyboard"></i> Custom Response Test
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button id="checkSynthesis" class="btn btn-danger w-100">
                            <i class="fas fa-heartbeat"></i> Check Synthesis
                        </button>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label class="form-label">Custom Text to Speak</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="customText" placeholder="Enter text to test speaking..." value="Hello! This is a test of the voice response system.">
                        <button class="btn btn-outline-secondary" type="button" id="speakCustomText">
                            <i class="fas fa-play"></i> Speak
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle"></i> Response Troubleshooting</h6>
                    <ul class="mb-0">
                        <li><strong>No Sound:</strong> Check system volume and speakers</li>
                        <li><strong>Browser Blocking:</strong> Some browsers require user interaction before speaking</li>
                        <li><strong>Permissions:</strong> Ensure browser allows audio playback</li>
                        <li><strong>Hardware:</strong> Verify speakers or headphones are connected</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const testResponseButton = document.getElementById('testResponseButton');
    const status = document.getElementById('status');
    const responseResults = document.getElementById('responseResults');
    const testBasicResponse = document.getElementById('testBasicResponse');
    const testGreetingResponse = document.getElementById('testGreetingResponse');
    const testCustomResponse = document.getElementById('testCustomResponse');
    const checkSynthesis = document.getElementById('checkSynthesis');
    const customText = document.getElementById('customText');
    const speakCustomText = document.getElementById('speakCustomText');
    
    // Add click event to main test button
    testResponseButton.addEventListener('click', function() {
        testVoiceResponse();
    });
    
    // Test basic response
    testBasicResponse.addEventListener('click', function() {
        speakText("This is a basic voice response test. If you can hear this, the system is working properly.");
        logResult('â†’ Testing basic voice response...');
    });
    
    // Test greeting response
    testGreetingResponse.addEventListener('click', function() {
        speakText("Hello! Welcome to the inventory management system. How can I help you today?");
        logResult('â†’ Testing greeting response...');
    });
    
    // Test custom response
    testCustomResponse.addEventListener('click', function() {
        const responses = [
            "I'm your inventory management assistant.",
            "You can ask me to show reports or navigate to different sections.",
            "Try saying commands like show me profit or add new product.",
            "I'm here to help you manage your inventory efficiently."
        ];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        speakText(randomResponse);
        logResult(`â†’ Testing custom response: ${randomResponse}`);
    });
    
    // Check speech synthesis
    checkSynthesis.addEventListener('click', function() {
        checkSpeechSynthesis();
    });
    
    // Speak custom text
    speakCustomText.addEventListener('click', function() {
        const text = customText.value;
        if (text.trim()) {
            speakText(text);
            logResult(`â†’ Speaking custom text: ${text}`);
        } else {
            logResult('âœ— No text entered for custom speech');
        }
    });
    
    // Main voice response test
    function testVoiceResponse() {
        logResult('=== Starting Voice Response Test ===');
        status.textContent = 'Testing voice response...';
        status.className = 'mt-2 text-primary';
        
        // Check speech synthesis support
        checkSpeechSynthesis();
        
        // Test basic speaking
        setTimeout(() => {
            speakText("Voice response system test completed successfully.");
            logResult('â†’ Voice response test completed');
        }, 1000);
        
        setTimeout(() => {
            status.textContent = 'Response test complete';
            status.className = 'mt-2 text-success';
            logResult('=== Response Test Complete ===');
        }, 3000);
    }
    
    // Check speech synthesis support
    function checkSpeechSynthesis() {
        const synthesis = window.speechSynthesis;
        
        if (!synthesis) {
            logResult('âœ— Speech Synthesis - NOT Supported');
            logResult('  â†’ Recommendation: Use Chrome or Edge browser');
            return false;
        }
        
        logResult('âœ“ Speech Synthesis - Supported');
        
        // Check if voices are available
        const voices = synthesis.getVoices();
        logResult(`âœ“ Available voices: ${voices.length}`);
        
        if (voices.length === 0) {
            // Wait for voices to load
            synthesis.onvoiceschanged = function() {
                const updatedVoices = synthesis.getVoices();
                logResult(`âœ“ Voices loaded: ${updatedVoices.length}`);
                if (updatedVoices.length > 0) {
                    logResult(`  â†’ Default voice: ${updatedVoices[0].name}`);
                }
            };
        } else if (voices.length > 0) {
            logResult(`  â†’ Default voice: ${voices[0].name}`);
        }
        
        return true;
    }
    
    // Speak text function with comprehensive error handling
    function speakText(text) {
        const synthesis = window.speechSynthesis;
        
        if (!synthesis) {
            logResult('âœ— Cannot speak - Speech synthesis not supported');
            return;
        }
        
        // Cancel any ongoing speech
        try {
            synthesis.cancel();
        } catch (e) {
            console.warn('Could not cancel ongoing speech:', e);
        }
        
        // Create utterance with error handling
        try {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Event listeners
            utterance.onstart = function() {
                logResult(`ðŸ”Š Speech started: "${text}"`);
                status.textContent = 'Speaking...';
                status.className = 'mt-2 text-info';
            };
            
            utterance.onend = function() {
                logResult('âœ… Speech ended successfully');
                status.textContent = 'Ready';
                status.className = 'mt-2 text-muted';
            };
            
            utterance.onerror = function(event) {
                logResult(`âœ— Speech error: ${event.error}`);
                logResult(`  â†’ Error details: ${JSON.stringify(event)}`);
                status.textContent = `Error: ${event.error}`;
                status.className = 'mt-2 text-danger';
            };
            
            // Speak the utterance
            synthesis.speak(utterance);
            logResult(`â†’ Queued speech: "${text}"`);
            
        } catch (error) {
            logResult(`âœ— Error creating utterance: ${error.message}`);
        }
    }
    
    // Log response result
    function logResult(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('p');
        logEntry.className = 'mb-1';
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        
        // Remove placeholder if it exists
        if (responseResults.querySelector('.text-muted')) {
            responseResults.innerHTML = '';
        }
        
        responseResults.appendChild(logEntry);
        responseResults.scrollTop = responseResults.scrollHeight;
    }
    
    // Initialize with a welcome message
    logResult('Voice Response Test System Ready');
    logResult('Click any test button to begin');
});
</script>
{% endblock %}