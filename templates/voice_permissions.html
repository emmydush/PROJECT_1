{% extends 'base.html' %}

{% block title %}Voice Command Permissions - {{ business_settings.business_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-microphone-alt"></i> Voice Command Permissions</h2>
        </div>
        <p class="text-muted">Configure browser permissions for voice commands to work properly.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5>Browser Permission Setup</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle"></i> Microphone Access Required</h5>
                    <p class="mb-0">To use voice commands, you need to grant microphone permissions to this website.</p>
                </div>
                
                <h5>Chrome/Edge Permission Setup</h5>
                <ol>
                    <li>Click the lock icon or "i" icon in the address bar</li>
                    <li>Look for "Microphone" in the permissions list</li>
                    <li>Change the setting from "Block" to "Allow"</li>
                    <li>Refresh the page</li>
                    <li>Try using the voice command again</li>
                </ol>
                
                <div class="text-center my-4">
                    <img src="https://developers.google.com/web/fundamentals/media/recording-audio/images/getusermedia-device-info-chrome.png" alt="Chrome Permissions" class="img-fluid border rounded" style="max-height: 200px;">
                </div>
                
                <h5>Firefox Permission Setup</h5>
                <ol>
                    <li>Click the lock icon in the address bar</li>
                    <li>Click "Permissions"</li>
                    <li>Find "Use the Microphone"</li>
                    <li>Change to "Allow"</li>
                    <li>Refresh the page</li>
                </ol>
                
                <h5 class="mt-4">Alternative Solutions</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <h6><i class="fas fa-sync-alt"></i> Refresh Page</h6>
                            <p>After changing permissions, refresh the page to apply changes.</p>
                            <button id="refreshPage" class="btn btn-primary btn-sm">Refresh Now</button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <h6><i class="fas fa-microphone"></i> Test Microphone</h6>
                            <p>Check if your microphone is working properly.</p>
                            <button id="testMicrophone" class="btn btn-info btn-sm">Test Microphone</button>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle"></i> Browser Compatibility</h6>
                    <p class="mb-0">Voice commands work best in <strong>Chrome</strong> and <strong>Edge</strong>. 
                    Firefox has limited support, and Safari may require additional configuration.</p>
                </div>
                
                <div class="mt-4">
                    <button id="checkPermissions" class="btn btn-success">
                        <i class="fas fa-check"></i> Check Current Permissions
                    </button>
                    <button id="requestPermissions" class="btn btn-primary ms-2">
                        <i class="fas fa-microphone"></i> Request Microphone Access
                    </button>
                </div>
                
                <div id="permissionStatus" class="mt-3 p-3 border rounded" style="display: none;">
                    <h6>Permission Status:</h6>
                    <p id="permissionText" class="mb-0"></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshPage = document.getElementById('refreshPage');
    const testMicrophone = document.getElementById('testMicrophone');
    const checkPermissions = document.getElementById('checkPermissions');
    const requestPermissions = document.getElementById('requestPermissions');
    const permissionStatus = document.getElementById('permissionStatus');
    const permissionText = document.getElementById('permissionText');
    
    // Refresh page button
    refreshPage.addEventListener('click', function() {
        location.reload();
    });
    
    // Test microphone button
    testMicrophone.addEventListener('click', function() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                // Stop all tracks to release the microphone
                stream.getTracks().forEach(track => track.stop());
                alert('Microphone is working properly!');
            })
            .catch(function(err) {
                alert('Microphone test failed: ' + err.message);
            });
    });
    
    // Check permissions button
    checkPermissions.addEventListener('click', function() {
        checkMicrophonePermission();
    });
    
    // Request permissions button
    requestPermissions.addEventListener('click', function() {
        requestMicrophonePermission();
    });
    
    // Check current microphone permission status
    function checkMicrophonePermission() {
        if (!navigator.permissions) {
            showPermissionStatus('Permissions API not supported in your browser.', 'warning');
            return;
        }
        
        navigator.permissions.query({ name: 'microphone' })
            .then(function(permissionStatus) {
                updatePermissionStatus(permissionStatus.state);
                
                // Listen for permission changes
                permissionStatus.onchange = function() {
                    updatePermissionStatus(this.state);
                };
            })
            .catch(function(err) {
                showPermissionStatus('Error checking permissions: ' + err.message, 'danger');
            });
    }
    
    // Request microphone permission
    function requestMicrophonePermission() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                // Stop all tracks to release the microphone
                stream.getTracks().forEach(track => track.stop());
                showPermissionStatus('Microphone access granted! You can now use voice commands.', 'success');
            })
            .catch(function(err) {
                let message = 'Microphone access denied. ';
                if (err.name === 'NotAllowedError') {
                    message += 'Please enable microphone permissions in your browser settings.';
                } else if (err.name === 'NotFoundError') {
                    message += 'No microphone found. Please connect a microphone and try again.';
                } else {
                    message += err.message;
                }
                showPermissionStatus(message, 'danger');
            });
    }
    
    // Update permission status display
    function updatePermissionStatus(state) {
        let message, type;
        switch (state) {
            case 'granted':
                message = 'Microphone permission is granted. Voice commands should work.';
                type = 'success';
                break;
            case 'denied':
                message = 'Microphone permission is denied. Please enable it in browser settings.';
                type = 'danger';
                break;
            case 'prompt':
                message = 'Microphone permission is pending. You will be prompted to allow access.';
                type = 'warning';
                break;
            default:
                message = 'Microphone permission status: ' + state;
                type = 'info';
        }
        showPermissionStatus(message, type);
    }
    
    // Show permission status message
    function showPermissionStatus(message, type) {
        permissionStatus.style.display = 'block';
        permissionText.textContent = message;
        permissionText.className = 'mb-0 text-' + type;
    }
    
    // Check permissions on page load
    if (navigator.permissions) {
        checkMicrophonePermission();
    }
});
</script>
{% endblock %}